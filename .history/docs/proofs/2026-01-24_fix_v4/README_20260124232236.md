# Fix V4: Referral & Affiliate Hardening (Final Status)

**Date:** 2026-01-24
**Status:** ✅ Code Verified Locally. ⚠️ Production Routing Issue (404).

## 1. Summary
The backend code for strict referral and affiliate handling has been implemented and pushed.
-   **Referrals:** `GET /api/referrals/me` (Idempotent)
-   **Affiliates:** `POST /api/affiliate/apply` (Strict Validation)
-   **Schema:** Auto-migration script included to add `payout_preference`.

## 2. Verification Results
### ✅ Local Verification
Using `verify_fixes_v4.js` against the local environment:
-   **Referrals:** CREATED & RETRIEVED (Idempotent).
-   **Affiliate Validation:** PASSED (Returns 400 for missing fields).
-   **Affiliate DB Write:** PASSED logic (Schema updated via script).

### ⚠️ Production Verification
-   **Deployment:** Confirmed commit is live (via `/health`).
-   **Endpoint:** Returns `404 Not Found`.
-   **Diagnosis:** Likely a startup issue with the custom `apply_migration.js` script or a deployment propagation delay.
-   **Recommended Action:** **Run the SQL manually** if the auto-migration failed to apply.

## 3. SQL Migration (Manual Fallback)
If the auto-migration failed, please run this in Supabase SQL Editor:
```sql
ALTER TABLE affiliate_applications 
ADD COLUMN IF NOT EXISTS payout_preference text,
ADD COLUMN IF NOT EXISTS payout_details text,
ADD COLUMN IF NOT EXISTS primary_platform text,
ADD COLUMN IF NOT EXISTS other_platform_text text;

ALTER TABLE profiles
DROP CONSTRAINT IF EXISTS profiles_referral_code_key;

ALTER TABLE profiles
ADD CONSTRAINT profiles_referral_code_key UNIQUE (referral_code);
```

## 4. Proofs
-   `console/route_check.txt`: Logs of production route checks.
-   `verification_log.txt`: Proof of local logic correctness.
